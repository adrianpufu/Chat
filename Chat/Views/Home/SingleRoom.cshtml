@using Chat.Models
@model SingleRoomViewModel

@{
    ViewBag.Title = "SingleRoom";
}

<div class="container">
    <div class="row " style="padding-top:40px;">
        <h3 class="text-center">You are in room @Model.Room.RoomName</h3>
        <br /><br />
        <div class="col-md-8">
            <div class="panel panel-info">
                <div class="panel-heading">
                    Room Chat
                </div>
                <div class="panel-body">
                    <ul id="discussion" class="media-list">
                        @if (Model.Room.Messages.Any() == true)
                        {
                            foreach (var mess in Model.Room.Messages)
                            {
                                <li class="media">

                                    <div class="media-body">

                                        <div class="media">
                                            @*<a class="pull-left" href="#">
                                                    <img class="media-object img-circle " src="assets/img/user.png" />
                                                </a>*@
                                            <div class="media-body">
                                                @mess.Content
                                                <br />
                                                <small class="text-muted">@mess.Author</small>
                                                <hr />
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="media">
                                <div class="media-body">
                                    <div class="media">
                                        <div class="media-body">
                                            Bine ai venit pe @Model.Room.RoomName
                                            <br />
                                            <small class="text-muted">Admin</small>
                                            <hr />
                                        </div>
                                    </div>
                                </div>
                            </li>
                        }
                    </ul>
                </div>
                <div class="panel-footer">
                    <div class="input-group">
                        <input type="text" class="form-control" id="message" placeholder="Enter Message" />
                        <span class="input-group-btn">
                            <button class="btn btn-info" id="sendmessage" type="button">SEND</button>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="panel panel-primary">
                <div class="panel-heading">
                    ONLINE USERS
                </div>
                <div class="panel-body">
                    <ul class="media-list">
                        @foreach (var user in Model.Room.Users)
                        {
                            <li class="media">
                                <div class="media-body">
                                    <div class="media">
                                        <div class="media-body">
                                            <h5>@Html.ActionLink(user.UserName, "SingleUser", new { userName = user.UserName }) @*| User*@ </h5>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <h3 class="text-center">
        <input type="button" class="connectToRoom btn btn-primary" value="Connect" />
        <input type="button" class="removeFromRoom btn btn-danger" value="Disconnect" />
    </h3>
</div>
@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.2.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <!--SignalR script to update the chat page and send messages.-->
    <script>
        $(function () {
            var roomName = @Html.Raw(Json.Encode(Model.Room.RoomName));
            // Reference the auto-generated proxy for the hub.
            var chat = $.connection.chatHub;
            // Create a function that the hub can call back to display messages.
            chat.client.addNewMessageToPage = function (name, message) {
                // Add the message to the page.
                $('#discussion').append("<li class=" + "media" +"><div class="+"media-body"+"><div class="+"media"+"><div class="+"media-body"+">" + htmlEncode(message) +"<br /><small class=" +"text-muted"+">"+ htmlEncode(name) +"</small><hr /></div></div></div></li>");
            };
            $('#message').focus();
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('.connectToRoom').click(function () {
                    // Call the AddToRoom method on the hub.
                    chat.server.addToRoom(roomName);
                });
                $('.removeFromRoom').click(function () {
                    // Call the AddToRoom method on the hub.
                    chat.server.leaveRoom(roomName);
                });
                $('#sendmessage').click(function () {
                    // Call the Send method on the hub.
                    chat.server.sendMessageToRoom(roomName, $('#message').val());
                    // Clear text box and reset focus for next comment.
                    $('#message').val('').focus();
                });
            });
        });
        // This optional function html-encodes messages for display in the page.
        function htmlEncode(value) {
            var encodedValue = $('<div />').text(value).html();
            return encodedValue;
        }
    </script>
}
